name: Deploy to Production

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'Reason for deployment'
        required: false
        default: 'Manual trigger'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load environment variables from file
        run: |
          echo "Loading env variables from prod.env"
          set -a
          source prod.env
          set +a
          # Export to GITHUB_ENV so other steps can use them
          while IFS= read -r line || [ -n "$line" ]; do
            if [[ ! "$line" =~ ^# && "$line" == *"="* ]]; then
              echo "$line" >> "$GITHUB_ENV"
            fi
          done < prod.env

      - name: Print deployment info (safe)
        run: |
          echo "Deployment Reason: ${{ github.event.inputs.deployment_reason }}"
          echo "Region: $PROD_REGION"
          echo "Endpoint: $PROD_ENDPOINT"
          echo "test $PROD_API_KEY2"

      - name: Use API key securely
        run: |
          echo "Triggering deployment call..."
          curl -H "Authorization: Bearer $PROD_API_KEY" "$PROD_ENDPOINT/deploy"
        env:
          PROD_API_KEY: ${{ secrets.PROD_API_KEY }}  # Use secrets here
